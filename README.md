# cmForth
Chuck's cmForth source/metacompiler based on RTX2000 version.

My stady playground about cmForth implementation, and Gamilacian secrets of the metacompiler.

オリジナルのソースコードはFORTH流ディスク用法(64x16文字を1ページとして扱い、ページ単位で`LOAD`出来る)でメタコンパイラとして書かれている。Chuckの洗練の極致に至っているようで、とても凡人に読めるものではない。

## source origin

`cmForth-RXT2000.txt`: https://eforth.com.tw/academy-n/chips/Harris%20Rtx2000/Rtx2000_5.htm

おそらく Dr. Chenのサイトのコンテンツだろう。https://eforth.com.tw/ からリンクをたどってここにたどり着けるかどうかは不明です。

`cmForth-NC4016.*`: https://github.com/ForthHub/cmFORTH

本来、`cmforth.fth` と `cmforth.txt`を左右並べて見るのが正しい見方であって、上記 cmForth-RTX2000.txt`はすでにその形式になっているとみなすべきなのだろう。

`382125.382916.pdf`: メタコンパイラとはなんぞやについてのACM誌の記事"Demise of the Metacompiler in cmForth"。Chuckの近況も読めるというお得な1本。

## メタコンパイラ

Forthシステム自体を生成するもので、今使っている実行環境から大きく変えたいときに別実行環境を生成する。サポートデバイスが変わるとか増えるとか、言語に新機能追加とか。別マシン用実行環境の生成もメタコンパイルで対応するらしい。ターゲット環境とネーティブ環境を区別している。

どの機械もOSとストレージを持っていて、そのOS上で動くバイナリはどのマシンの上でも動くというのが今風なのだが、当時(70年代末～80年代)にはOSとハードディスクを持っていないマシンもあった。スイッチぱちぱち、紙テープリーダ、テレタイプの出力というマシンなら、スイッチぱちぱち紙テープ読み込みプログラム(ブートローダですね)を打ち込んで、Forthコアと辞書のセットを紙テープにパンチして毎回読み込ませるというのが普通だっただろう。

新しいマシン用の実行環境はFORTHインタプリタと新しいマシン用のデバイスIOコードの組み合わせから成る。辞書中の単語の殆どは、他のワードの参照(ポインタ)の列からなっているので、新しいマシン用の辞書は古いマシンの辞書のコピーで良い。但し、アドレス情報はすべて新しいマシンの辞書開始番地に対するオフセットを補正する必要がある。単語イメージのどこが辞書内参照アドレスであるかは単語のフォーマットを知っているForthインタプリタ自身にやらせるのがよい。ということなのだと推察している。

いまある辞書からコピーして新しい実行環境を作る。コンパイル済みの辞書をオフセットを変えてコピーする。場合によっては新マシン用の機械語入り単語もダンプしておく、あたりなのだと思う。